<!-- src/app/public/pages/dashboard/dashboard-view-message/dashboard-view-message.component.html -->
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <!-- Breadcrumb -->
  <div
    class="flex items-center space-x-2 bg-[#F6F6F6] border border-[#F6F6F6] px-4 py-1 rounded-full text-xs mb-8 w-fit"
  >
    <a
      class="text-[#97999B] font-semibold"
      [routerLink]="['/dashboard']"
      >Dashboard</a
    >
    <span class="text-[#3C3D3E]">›</span>
    <a
      class="text-[#97999B] font-semibold"
      [routerLink]="['/dashboard/messaggi']"
      >Centro messaggi</a
    >
    <span class="text-[#3C3D3E]">›</span>
    <span class="text-black font-bold">Scheda messaggio</span>
  </div>

  <!-- Loading State -->
  @if (isLoading && !ticket) {
    <div class="flex justify-center items-center py-16">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div>
    </div>
  }

  <!-- Error State -->
  @else if (hasError) {
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      <span class="block sm:inline">{{ errorMessage }}</span>
      <button
        (click)="loadTicket()"
        class="ml-2 underline hover:no-underline"
      >
        Riprova
      </button>
    </div>
  }

  <!-- Ticket Content -->
  @else if (ticket) {
    <div class="max-w-4xl mb-20">
      <!-- Message Status Bar -->
      <div
        class="flex flex-wrap items-center justify-between gap-4 mb-8 border border-gray-300 p-4 rounded"
      >
        <div class="flex flex-wrap items-center space-x-4">
          <span
            class="px-3 py-1 rounded-sm text-xs font-bold"
            [ngClass]="getStatusBadgeClass(ticket.ticketStatus)"
          >
            {{ getDisplayStatus(ticket.ticketStatus) }}
          </span>

          @if (ticket.priority === 'HIGH' || ticket.priority === 'URGENT') {
            <span class="px-2 py-1 bg-red-100 text-red-800 rounded-sm text-xs font-bold">
              {{ ticketService.formatPriority(ticket.priority) }}
            </span>
          }

          <span class="text-[#97999B] text-sm">Ticket #{{ ticket.id }}</span>
          <span class="text-[#97999B] text-sm"
            >Creato il {{ formatDateShort(ticket.creationDate) }}</span
          >
          <span class="text-[#97999B] text-sm">{{ getPropertyReference() }}</span>
        </div>

        <!-- Only show reopen button for closed/resolved tickets -->
        <div class="flex flex-wrap gap-2">
          @if (canReopenTicket()) {
            <app-button
              type="primary"
              size="sm"
              (click)="reopenTicket()"
            >
              Riapri ticket
            </app-button>
          }
        </div>
      </div>

      <!-- Ticket Details -->
      <div class="space-y-8">
        <!-- Request Type and Subject -->
        <div>
          <h2 class="text-lg font-bold mb-2">Oggetto</h2>
          <p class="text-black font-semibold">{{ ticket.subject }}</p>
        </div>

        <div>
          <h2 class="text-lg font-bold mb-2">Tipologia richiesta</h2>
          <p class="text-black">{{ getCategoryDisplayName(ticket.category) }}</p>
        </div>

        <!-- Original Message -->
        <div>
          <h2 class="text-lg font-bold mb-2">Messaggio iniziale</h2>
          <div class="bg-gray-50 p-4 rounded border">
            <div class="flex justify-between items-start mb-2">
              <span class="text-sm text-gray-600">{{ formatDate(ticket.creationDate) }}</span>
              <span class="text-sm text-gray-600">Creato da te</span>
            </div>
            <div
              class="text-black whitespace-pre-line"
              [innerHTML]="ticket.description"
            ></div>

            <!-- Original attachments -->
            @if (ticket.attachments && ticket.attachments.length > 0) {
              <div class="mt-4">
                <h4 class="text-sm font-semibold mb-2">Allegati:</h4>
                <div class="flex flex-wrap gap-4">
                  @for (attachment of ticket.attachments; track attachment.id) {
                    <div class="w-32">
                      @if (isImageFile(attachment.mime)) {
                        <img
                          [src]="attachment.url"
                          [alt]="attachment.name"
                          class="w-full h-24 object-cover rounded mb-2 cursor-pointer"
                          (click)="downloadAttachment(attachment)"
                        />
                      } @else {
                        <div
                          class="w-full h-24 bg-gray-100 rounded flex flex-col items-center justify-center mb-2 cursor-pointer"
                          (click)="downloadAttachment(attachment)"
                        >
                          <svg
                            class="w-6 h-6 text-gray-400 mb-1"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                            />
                          </svg>
                          <span class="text-xs text-gray-500">{{
                            getFileExtension(attachment.name)
                          }}</span>
                        </div>
                      }
                      <button
                        (click)="downloadAttachment(attachment)"
                        class="w-full text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors"
                      >
                        Scarica
                      </button>
                      <div
                        class="text-xs text-gray-500 mt-1 truncate"
                        [title]="attachment.name"
                      >
                        {{ attachment.name }}
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Conversation Threads -->
        @if (ticket.threads && ticket.threads.length > 0) {
          <div>
            <h2 class="text-lg font-bold mb-4">Conversazione</h2>
            <div class="space-y-4">
              @for (thread of ticket.threads; track thread.id) {
                <div
                  class="border rounded p-4"
                  [ngClass]="getThreadClass(thread)"
                >
                  <div class="flex justify-between items-start mb-2">
                    <span class="text-sm font-semibold">{{ getThreadTypeDisplay(thread) }}</span>
                    <span class="text-sm text-gray-600">{{ formatDate(thread.creationDate) }}</span>
                  </div>

                  <div
                    class="text-black whitespace-pre-line mb-3"
                    [innerHTML]="thread.message"
                  ></div>

                  <!-- Thread attachments -->
                  @if (thread.attachments && thread.attachments.length > 0) {
                    <div class="mt-3">
                      <h5 class="text-sm font-semibold mb-2">Allegati:</h5>
                      <div class="flex flex-wrap gap-3">
                        @for (attachment of thread.attachments; track attachment.id) {
                          <div class="w-28">
                            @if (isImageFile(attachment.mime)) {
                              <img
                                [src]="attachment.url"
                                [alt]="attachment.name"
                                class="w-full h-20 object-cover rounded mb-1 cursor-pointer"
                                (click)="downloadAttachment(attachment)"
                              />
                            } @else {
                              <div
                                class="w-full h-20 bg-gray-100 rounded flex flex-col items-center justify-center mb-1 cursor-pointer"
                                (click)="downloadAttachment(attachment)"
                              >
                                <svg
                                  class="w-5 h-5 text-gray-400 mb-1"
                                  viewBox="0 0 24 24"
                                  fill="none"
                                  stroke="currentColor"
                                >
                                  <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                  />
                                </svg>
                                <span class="text-xs text-gray-500">{{
                                  getFileExtension(attachment.name)
                                }}</span>
                              </div>
                            }
                            <button
                              (click)="downloadAttachment(attachment)"
                              class="w-full text-xs bg-gray-100 hover:bg-gray-200 px-1 py-1 rounded transition-colors"
                            >
                              Scarica
                            </button>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }

        <!-- Always Visible Reply Form -->
        @if (canUserReply()) {
          <div class="bg-blue-50 border border-blue-200 rounded p-6">
            <h3 class="text-lg font-bold mb-4">Aggiungi una risposta</h3>

            @if (!canUserReply()) {
              <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
                <div class="flex items-center">
                  <svg
                    class="w-5 h-5 text-yellow-400 mr-2"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  <div>
                    <p class="text-sm text-yellow-800 font-medium">
                      @if (ticket.ticketStatus === 'CLOSED') {
                        Questo ticket è stato chiuso. Non è possibile aggiungere nuove risposte.
                      } @else if (!hasAgentResponse()) {
                        Devi attendere una risposta dall'assistenza prima di poter rispondere
                        nuovamente.
                      }
                    </p>
                  </div>
                </div>
              </div>
            }

            <form
              [formGroup]="replyForm"
              (ngSubmit)="submitReply()"
              class="space-y-4"
            >
              <div>
                <app-input
                  [control]="getControl('message')"
                  type="textarea"
                  [rows]="6"
                  label="Il tuo messaggio"
                  [isDisabled]="!canUserReply()"
                ></app-input>
              </div>

              <div>
                <label class="block text-sm font-medium mb-2">Allegati (opzionale)</label>
                <app-file-uploader
                  [type]="'file'"
                  (filesSelected)="onFileUpload($any($event))"
                ></app-file-uploader>
                <p class="text-sm text-gray-500 mt-1">
                  Formati accettati: PDF, Word, Excel, JPG, PNG, GIF (max 10 MB)
                </p>
              </div>

              <div class="flex gap-2">
                <app-button
                  type="primary"
                  [isDisabled]="replyForm.invalid || isSubmittingReply || !canUserReply()"
                  size="md"
                >
                  {{ isSubmittingReply ? 'Invio...' : 'Invia risposta' }}
                </app-button>

                @if (canUserReply()) {
                  <app-button
                    type="secondary"
                    (click)="clearReplyForm()"
                    size="md"
                    [isDisabled]="isSubmittingReply"
                  >
                    Cancella
                  </app-button>
                }
              </div>
            </form>
          </div>
        }

        <!-- Status Information -->
        @if (ticket.ticketStatus === 'CLOSED' || ticket.ticketStatus === 'RESOLVED') {
          <div class="bg-green-50 border border-green-200 rounded p-4">
            <h3 class="text-lg font-bold text-green-800 mb-2">
              @if (ticket.ticketStatus === 'CLOSED') {
                Ticket Chiuso
              } @else {
                Ticket Risolto
              }
            </h3>
            <p class="text-green-700">
              @if (ticket.closedDate) {
                Data di chiusura: {{ formatDate(ticket.closedDate) }}
              }
              @if (ticket.resolutionTime) {
                <br />Tempo di risoluzione: {{ ticket.resolutionTime }} minuti
              }
            </p>
            @if (ticket.ticketStatus === 'RESOLVED') {
              <p class="text-sm text-green-600 mt-2">
                Se il problema non è stato risolto completamente, puoi riaprire il ticket.
              </p>
            }
          </div>
        }
      </div>
    </div>
  }
</div>

@if (this.modalType) {
  <app-modal-small
    [modalType]="modalType"
    [loading]="false"
    [params]="{title: 'Sei sicuro di voler riaprire questo ticket?'}"
    (onAction)="modalAction()"
    (onClose)="modalClosed()"></app-modal-small>

}
