<!-- src/app/cms/pages/guide/guide-details/guide-details.component.html -->
<div class="container mx-auto">
  <h1 class="heading-md font-bold text-primary-dark mb-6">
    {{ isNewGuide ? 'Nuovo contenuto' : 'Modifica contenuto' }}
  </h1>

  <!-- Tabs Navigation -->
  <div class="flex mb-4 border-b border-[#CBCCCD]">
    <div
      class="px-6 py-3 cursor-pointer flex items-center gap-2 text-[#97999B] font-bold border-[#CBCCCD]"
      (click)="setActiveTab('content')"
      [ngClass]="{
        'border-b-2 border-black -mb-[2px] bg-secondary text-black font-bold ':
          activeTab() === 'content',
      }"
    >
      <span
        class="inline-flex items-center justify-center rounded-full bg-gray-200 w-5 h-5 text-sm font-bold"
        >1</span
      >
      Testo e dati
    </div>
    <div
      class="px-6 py-3 cursor-pointer flex items-center gap-2 text-[#97999B] font-bold border-[#CBCCCD]"
      [ngClass]="{
        'border-b-2 border-black -mb-[2px] bg-secondary text-black font-bold':
          activeTab() === 'preview',
      }"
      (click)="setActiveTab('preview')"
    >
      <span
        class="inline-flex items-center justify-center rounded-full bg-gray-200 w-5 h-5 text-sm font-bold"
        >2</span
      >
      Anteprima
    </div>
  </div>

  <!-- Loading state -->
  @if (isLoading()) {
    <div class="flex justify-center py-10">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div>
    </div>
  }

  <!-- Error message -->
  @if (error()) {
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      <span class="block sm:inline">{{ error() }}</span>
      <button
        class="absolute top-0 bottom-0 right-0 px-4 py-3"
        (click)="error.set(null)"
      >
        <span class="sr-only">Chiudi</span>
      </button>
    </div>
  }

  <!-- Content Tab -->
  @if (activeTab() === 'content' && !isLoading()) {
    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
      <!-- Left column: Form fields -->
      <div class="md:col-span-7">
        <form
          [formGroup]="guideForm"
          class="space-y-6"
        >
          <!-- Title field -->
          <div>
            <app-input
              label="Titolo*"
              [control]="getControl('title')"
            ></app-input>
          </div>

          <!-- Description field with word counter -->
          <div>
            <div class="mb-1 flex justify-between items-center">
              <label class="block text-sm font-medium text-gray-700"
                >Testo preview* (max 20 parole)</label
              >
            </div>
            <app-input
              [control]="getControl('description')"
              type="textarea"
              [rows]="5"
            ></app-input>
            @if (
              getControl('description').touched && getControl('description').hasError('wordLimit')
            ) {
              <p class="mt-1 text-sm text-red-500">
                Il testo non pu√≤ superare {{ maxWords }} parole.
              </p>
            }
          </div>

          <!-- Publication date and time -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Data pubblicazione*</label
              >
              <input
                type="date"
                formControlName="publicationDate"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-300"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ora pubblicazione*</label>
              <input
                type="time"
                formControlName="publicationTime"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-300"
              />
            </div>
          </div>
        </form>
      </div>

      <!-- Right column: File and Image uploaders -->
      <div class="md:col-span-5">
        <!-- File uploader -->
        <div class="mb-8">
          <label class="block text-sm font-medium text-gray-700 mb-2">File scaricabile</label>
          <app-guide-file-uploader
            [guideId]="guideId"
            [initialFile]="uploadedFile"
            (fileUploaded)="onFileUploaded($event)"
          ></app-guide-file-uploader>
          <p class="text-xs text-gray-500 mt-2">
            Formati accettati: PDF, word, jpeg, png, gif max 50 mb
          </p>
        </div>

        <!-- Image uploader -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Immagine in evidenza</label>
          <app-guide-image-uploader
            [guideId]="guideId"
            [initialImage]="uploadedImage"
            (imageUploaded)="onImageUploaded($event)"
          ></app-guide-image-uploader>
          <p class="text-xs text-gray-500 mt-2"> Formati accettati: jpeg, png, gif max 10 mb </p>
        </div>
      </div>
    </div>

    <!-- Action buttons -->
    <div class="flex justify-between mt-8 mb-8">
      <div>
        <app-button
          type="secondary"
          [text]="'Salva bozza'"
          [size]="'md'"
          (buttonClick)="saveDraft()"
          [icon]="true"
          [iconType]="'floppy'"
          iconPosition="left"
        ></app-button>
      </div>
      <div class="flex gap-3">
        <app-button
          type="secondary"
          [text]="'Annulla'"
          [size]="'md'"
          (buttonClick)="onCancel()"
        ></app-button>
        <app-button
          type="primary"
          [text]="'Avanti'"
          [size]="'md'"
          [icon]="true"
          [iconType]="'arrow-right'"
          iconPosition="right"
          (buttonClick)="onNext()"
        ></app-button>
      </div>
    </div>
  }

  <!-- Preview Tab -->
  @if (activeTab() === 'preview' && !isLoading()) {
    <div class="container mx-auto max-w-5xl px-4">
      <div class="bg-white rounded border-[1px] border-[#CBCCCD] overflow-hidden shadow-lg">
        <!-- Cover Image -->
        @if (uploadedImage) {
          <img
            [src]="uploadedImage.url"
            [alt]="guideForm.value.title"
            class="w-full h-48 object-cover object-center"
          />
        } @else {
          <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
            <span class="text-gray-500">Nessuna immagine caricata</span>
          </div>
        }

        <!-- Content -->
        <div class="p-5 text-left">
          <h5 class="heading-md text-primary-dark font-bold mb-3 font-montserrat">
            {{ guideForm.value.title }}
          </h5>
          <p class="text-black text-sm">{{ guideForm.value.description }}</p>
        </div>

        <!-- Download area -->
        <div class="p-5 bg-gray-100 text-center">
          @if (uploadedFile) {
            <app-button
              class="text-primary-dark font-bold"
              [text]="'Leggi la guida'"
              [iconType]="'download'"
              [icon]="true"
              iconPosition="right"
              size="md"
            ></app-button>
          } @else {
            <p class="text-gray-500">Nessun file caricato</p>
          }
        </div>
      </div>

      <!-- Action buttons -->
      <div class="flex justify-between mt-8 mb-8">
        <div>
          <app-button
            type="secondary"
            [text]="'Indietro'"
            (buttonClick)="setActiveTab('content')"
            [icon]="true"
            [size]="'md'"
            [iconType]="'arrow-left'"
            iconPosition="left"
          ></app-button>
        </div>
        <div class="flex gap-3">
          <app-button
            type="secondary"
            [text]="'Annulla'"
            [size]="'md'"
            (buttonClick)="onCancel()"
          ></app-button>
          <app-button
            type="primary"
            [text]="isSaving() ? 'Pubblicando...' : 'Conferma e pubblica contenuto'"
            [isDisabled]="isSaving() || guideForm.invalid"
            [icon]="true"
            [iconType]="'floppy'"
            [size]="'md'"
            iconPosition="right"
            (buttonClick)="onSubmit()"
          ></app-button>
        </div>
      </div>
    </div>
  }
</div>
