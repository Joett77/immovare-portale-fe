<!-- src/app/cms/pages/ticket-assistance/ticket-assistance-detail/ticket-assistance-detail.component.html -->
<div class="container mx-auto py-6">
  <!-- Header with status and basic info -->
  <div class="mb-6">
    <div class="flex items-center gap-4 mb-4 bg-[#F6F6F6] p-4 rounded-lg">
      <span
        class="px-3 py-1 rounded-sm text-xs font-bold"
        [ngClass]="getStatusBadgeClass()"
      >
        {{ getStatusText() }}
      </span>
      <span class="text-sm text-gray-600"><b>ID:</b> #{{ ticket()?.id }}</span>
      <span class="text-sm text-gray-600"
        ><b>Data richiesta:</b> {{ formatDate(ticket()?.creationDate) }}</span
      >
      <span class="text-sm text-gray-600"><b>Rif. Annuncio:</b> {{ getPropertyReference() }}</span>
      <span class="text-sm text-gray-600">
        <b>Richiedente:</b>
        @if (isLoadingCustomer()) {
          <span class="inline-flex items-center">
            <div class="animate-spin rounded-full h-3 w-3 border-b-2 border-primary mr-1"></div>
            Caricamento...
          </span>
        } @else {
          {{ getCustomerName() }}
        }
      </span>
    </div>
  </div>

  <!-- Loading state -->
  @if (isLoading()) {
    <div class="flex justify-center py-10">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div>
    </div>
  }

  <!-- Error message -->
  @if (error()) {
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      <span class="block sm:inline">{{ error() }}</span>
      <button
        class="absolute top-0 bottom-0 right-0 px-4 py-3"
        (click)="error.set('')"
      >
        <span class="sr-only">Chiudi</span>
      </button>
    </div>
  }

  <!-- Main content -->
  @if (!isLoading() && ticket()) {
    <div class="grid grid-cols-12 gap-6">
      <!-- Main content area -->
      <div class="col-span-12 lg:col-span-8">
        <!-- Ticket Details -->
        <div class="bg-white rounded-lg p-6 mb-6">
          <h2 class="text-lg font-bold mb-4">Tipologia richiesta</h2>
          <p class="mb-4">{{ formatCategory(ticket()?.category) }}</p>

          <h2 class="text-lg font-bold mb-4">Messaggio</h2>
          <div class="bg-gray-50 mb-4">
            <div class="flex justify-between items-start mb-2">
              <span class="text-sm text-gray-600">{{ formatDate(ticket()?.creationDate) }}</span>
            </div>
            <div class="text-black whitespace-pre-line mb-3">{{ ticket()?.description }}</div>

            <!-- Original attachments -->
            @if (ticket()?.attachments?.length) {
              <div class="mt-4">
                <h4 class="text-lg font-semibold mb-2">Allegati:</h4>
                <div class="flex flex-wrap gap-4">
                  @for (attachment of ticket()?.attachments; track attachment.id) {
                    <div class="w-32">
                      @if (isImageFile(attachment.mime)) {
                        <img
                          [src]="attachment.url"
                          [alt]="attachment.name"
                          class="w-full h-24 object-cover rounded mb-2 cursor-pointer"
                          (click)="downloadAttachment(attachment)"
                        />
                      } @else {
                        <div
                          class="w-full h-24 bg-gray-100 rounded flex flex-col items-center justify-center mb-2 cursor-pointer"
                          (click)="downloadAttachment(attachment)"
                        >
                          <svg
                            class="w-6 h-6 text-gray-400 mb-1"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                            />
                          </svg>
                          <span class="text-xs text-gray-500">{{
                            getFileExtension(attachment.name)
                          }}</span>
                        </div>
                      }
                      <button
                        (click)="downloadAttachment(attachment)"
                        class="w-full text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors"
                      >
                        Scarica
                      </button>
                      <div
                        class="text-xs text-gray-500 mt-1 truncate"
                        [title]="attachment.name"
                      >
                        {{ attachment.name }}
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          </div>

          <!-- Conversation Threads -->
          @if (ticket()?.threads?.length) {
            <h2 class="text-lg font-bold mb-4">Conversazione</h2>
            <div class="space-y-4">
              @for (thread of ticket()?.threads; track thread.id) {
                <div
                  class="border rounded p-4"
                  [ngClass]="getThreadClass(thread)"
                >
                  <div class="flex justify-between items-start mb-2">
                    <span class="text-sm font-semibold">{{ getThreadTypeDisplay(thread) }}</span>
                    <span class="text-sm text-gray-600">{{ formatDate(thread.creationDate) }}</span>
                  </div>

                  <div class="text-black whitespace-pre-line mb-3">{{ thread.message }}</div>

                  <!-- Thread attachments -->
                  @if (thread.attachments && thread.attachments.length > 0) {
                    <div class="mt-3">
                      <h5 class="text-sm font-semibold mb-2">Allegati:</h5>
                      <div class="flex flex-wrap gap-3">
                        @for (attachment of thread.attachments; track attachment.id) {
                          <div class="w-28">
                            @if (isImageFile(attachment.mime)) {
                              <img
                                [src]="attachment.url"
                                [alt]="attachment.name"
                                class="w-full h-20 object-cover rounded mb-1 cursor-pointer"
                                (click)="downloadAttachment(attachment)"
                              />
                            } @else {
                              <div
                                class="w-full h-20 bg-gray-100 rounded flex flex-col items-center justify-center mb-1 cursor-pointer"
                                (click)="downloadAttachment(attachment)"
                              >
                                <svg
                                  class="w-5 h-5 text-gray-400 mb-1"
                                  viewBox="0 0 24 24"
                                  fill="none"
                                  stroke="currentColor"
                                >
                                  <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                  />
                                </svg>
                                <span class="text-xs text-gray-500">{{
                                  getFileExtension(attachment.name)
                                }}</span>
                              </div>
                            }
                            <button
                              (click)="downloadAttachment(attachment)"
                              class="w-full text-xs bg-gray-100 hover:bg-gray-200 px-1 py-1 rounded transition-colors"
                            >
                              Scarica
                            </button>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>

        <!-- Response Section -->
        <div class="p-6">
          <h3 class="text-lg font-bold mb-4">Risposta assistenza</h3>

          @if (ticket()?.ticketStatus === 'CLOSED') {
            <div class="bg-gray-100 border border-gray-300 rounded p-4 mb-4">
              <div class="flex items-center">
                <svg
                  class="w-5 h-5 text-gray-400 mr-2"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                <div>
                  <p class="text-sm text-gray-800 font-medium">
                    Questo ticket è stato chiuso. Non è possibile aggiungere nuove risposte.
                  </p>
                </div>
              </div>
            </div>
          }

          <form
            [formGroup]="responseForm"
            (ngSubmit)="submitResponse()"
            class="space-y-4"
          >
            <div>
              <app-input
                [control]="getControl('message')"
                type="textarea"
                [rows]="6"
                label="Risposta"
                [isDisabled]="ticket()?.ticketStatus === 'CLOSED'"
              ></app-input>
            </div>

            <div>
              @if (ticket()?.ticketStatus !== 'CLOSED') {
                <label class="block text-sm font-medium mb-2">Allegati (opzionale)</label>
                <app-simple-file-uploader
                  [acceptedTypes]="'image/*,.pdf,.doc,.docx,.xls,.xlsx'"
                  [maxFileSize]="10485760"
                  [maxFiles]="5"
                  [acceptedTypesText]="'PDF, Word, Excel, JPG, PNG, GIF (max 10 MB per file)'"
                  (filesSelected)="onFileUpload($event)"
                ></app-simple-file-uploader>
                <p class="text-sm text-gray-500 mt-1">
                  Formati accettati: PDF, Word, Excel, JPG, PNG, GIF (max 10 MB)
                </p>
              }
            </div>

            <div class="flex gap-2">
              <app-button
                type="primary"
                [isDisabled]="
                  responseForm.invalid ||
                  isSubmittingResponse() ||
                  ticket()?.ticketStatus === 'CLOSED'
                "
                size="md"
              >
                {{ isSubmittingResponse() ? 'Invio...' : 'Invia risposta' }}
              </app-button>

              <app-button
                type="secondary"
                (click)="clearResponseForm()"
                size="md"
                [isDisabled]="isSubmittingResponse() || ticket()?.ticketStatus === 'CLOSED'"
              >
                Cancella
              </app-button>
            </div>
          </form>
        </div>
      </div>

      <!-- Right sidebar with actions and info -->
      <div class="col-span-12 lg:col-span-4">
        <!-- Ticket Actions -->
        <div class="bg-gray-100 border border-gray-200 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-bold mb-4">Azioni ticket</h3>

          <!-- Status update -->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Stato ticket</label>
            <select
              [value]="ticket()?.ticketStatus"
              (change)="updateTicketStatus($any($event.target).value)"
              class="w-full p-2 border border-gray-300 rounded-sm text-sm bg-white"
              [disabled]="isUpdatingStatus()"
            >
              @for (status of statusOptions; track status.value) {
                <option [value]="status.value">{{ status.label }}</option>
              }
            </select>
          </div>

          <!-- Priority update -->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Priorità</label>
            <select
              [value]="ticket()?.priority"
              (change)="updateTicketPriority($any($event.target).value)"
              class="w-full p-2 border border-gray-300 rounded-sm text-sm bg-white"
              [disabled]="isUpdatingPriority()"
            >
              @for (priority of priorityOptions; track priority.value) {
                <option [value]="priority.value">{{ priority.label }}</option>
              }
            </select>
          </div>

          <!-- Quick actions -->
          <div class="space-y-2">
            @if (ticket()?.ticketStatus !== 'CLOSED') {
              <app-button
                type="primary"
                size="sm"
                class="w-full"
                (click)="closeTicket()"
                [isDisabled]="isUpdatingStatus()"
              >
                Chiudi ticket
              </app-button>
            }

            @if (ticket()?.ticketStatus === 'CLOSED') {
              <app-button
                type="secondary"
                size="sm"
                class="w-full"
                (click)="reopenTicket()"
                [isDisabled]="isUpdatingStatus()"
              >
                Riapri ticket
              </app-button>
            }
          </div>
        </div>
      </div>
    </div>
  }
</div>
